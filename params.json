{"name":"Setting up CarrierWave and MiniMagick in Sinatra","tagline":"","body":"###Setting up CarrierWave and MiniMagick in Sinatra\r\n\r\nOur challenge today was based around file uploading and manipulation, and configuring our Sinatra environment to work with these two external gems. After a whole lot of needless error-hunting, here is how I got it to work with our given Sinatra skeleton.\r\n\r\nFirst, we add the gems to the gemfile...\r\n\r\n    #Gemfile\r\n    gem 'carrierwave'\r\n    gem 'mini_magick'\r\n\r\nAnd the environment.\r\n\r\n    #environment.rb\r\n    require 'carrierwave'\r\n    require 'carrierwave/orm/activerecord'\r\n    require 'mini_magick'\r\n\r\nLet's include a place in our photos table to store the file: perhaps the filename, perhaps the path, either way we know it should be a string.\r\n\r\n    #create_photos_migration\r\n    t.string :file\r\nNext, to use the carrierwave gem we need to set up a class where we call it from. It doesn't really fit in to a Model/View/Controller folder, so I stashed it in a folder called uploader as the documentation (sort of) suggests.\r\n\r\n    #/uploader/uploader.rb\r\n    class Uploader < CarrierWave::Uploader::Base\r\n      storage :file\r\n\r\n      def store_dir\r\n        'images'\r\n      end\r\n    end\r\n\r\nA few things to note above. We define a class called Uploader (it could be anything) that inherits the functionality of the gem. We set the :storage attribute to reference the :file column in our photos table, and to not clutter our directories, we can set a store_dir method to save files in a new directory called 'images'. The above is further documented in the carrierwave repo.\r\n\r\nAnother thing we'll need to do now is add the files in that uploader folder to our environment. And while we're back in here, set the root of our uploader to work out of our public directory.\r\n\r\n    #environment.rb\r\n    Dir[APP_ROOT.join('app', 'uploaders', '*.rb')].each { |file| require file }\r\n    CarrierWave.configure do |config|\r\n        config.root = APP_ROOT + 'public/'\r\n    end\r\n\r\nLet's go to our Photo model and tell it...\r\n\r\n    #photo.rb\r\n    class Photo < ActiveRecord::Base\r\n        mount_uploader :file, Uploader \r\n    end\r\n\r\n...which basically means when we try to write to the :file column, we do the method 'mount_uploader' instead, calling the Uploader class we wrote up above.\r\n\r\nNow, in our controller, we can create a new photo, write the filename (and subsequently call the mounted methods), then save it.\r\n\r\n    #index.rb\r\n    post '/albums/:id' do\r\n        photo = current_user.albums.find(params[:id]).photos.new()\r\n        photo.file = params[:image]\r\n        photo.save\r\n    end\r\n\r\nOn success, this will write the filename to :file, create a temp directory you don't really need to worry about, and save the image file to /public/images/. Sweet.\r\n\r\nAlso, when we call <%= photo.file %>, the full path will be displayed (/public/images/filename.ext) instead of what is just written to the :file column. Super sweet.\r\n\r\nWe can simply include MiniMagick in our Uploader class, and call various methods from that, like resizing the image to fit in a 200 x 200 box.\r\n\r\n    #uploader.rb\r\n    class Uploader < CarrierWave::Uploader::Base\r\n        include CarrierWave::MiniMagick\r\n        process :resize_to_fill => [200, 200]\r\n        ...\r\n    end\r\n\r\nLastly, it turns out that MiniMagick is a wrapper for ImageMagick. I'm not sure if the DBC computers have it installed, but I had to install it on my machine before it would work, a la <code>brew install ImageMagick</code> and restart the server.\r\n\r\nThat should do it, happy uploading. (Let me know if there are any errors.)","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}